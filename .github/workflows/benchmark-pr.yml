
name: Benchmark Performance-Analysis

on:
  pull_request:
    branches: [main, master]

permissions:
  pull-requests: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.14.1

      - name: Install perf
        run: sudo apt-get update && sudo apt-get install -y linux-tools-common linux-tools-generic

      - name: Build benchmark
        run: zig build-exe -O ReleaseFast benchmark.zig

      - name: Run perf analysis
        run: |
          # Run perf and save output
          sudo perf stat -e LLC-loads,LLC-load-misses,LLC-stores,LLC-store-misses ./benchmark 2> perf.txt || true
          
          # Extract LLC miss rate
          LLC_LOAD_MISSES=$(grep "LLC-load-misses" perf.txt | awk '{print $1}' | tr -d ',')
          LLC_LOADS=$(grep "LLC-loads" perf.txt | awk '{print $1}' | tr -d ',')
          if [ "$LLC_LOADS" -ne 0 ]; then
            LLC_MISS_RATE=$(echo "scale=2; $LLC_LOAD_MISSES * 100 / $LLC_LOADS" | bc)
          else
            LLC_MISS_RATE="N/A"
          fi
          
          # Save results as environment variables
          echo "LLC_LOAD_MISSES=$LLC_LOAD_MISSES" >> $GITHUB_ENV
          echo "LLC_LOADS=$LLC_LOADS" >> $GITHUB_ENV
          echo "LLC_MISS_RATE=$LLC_MISS_RATE" >> $GITHUB_ENV

      - name: Comment PR with results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const perfData = fs.readFileSync('perf.txt', 'utf8');
            
            const comment = `## Performance Analysis Results (LLC Misses)

            **LLC Load Misses**: ${process.env.LLC_LOAD_MISSES}
            **LLC Loads**: ${process.env.LLC_LOADS}
            **LLC Miss Rate**: ${process.env.LLC_MISS_RATE}%

            <details>
            <summary>Full perf output</summary>

            \`\`\`
            ${perfData}
            \`\`\`
            </details>

            _Note: This analysis was performed using \`perf stat\` on the benchmark executable built with \`zig build-exe -O ReleaseFast\`_`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
